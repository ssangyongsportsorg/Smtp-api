<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTP 管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50">
    <!-- Login/Register Form -->
    <div id="authForm" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900" id="authTitle">
                    管理員登入
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600" id="authSubtitle">
                    請輸入您的帳號密碼
                </p>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="loginUsername" class="sr-only">使用者名稱</label>
                        <input id="loginUsername" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="使用者名稱">
                    </div>
                    <div>
                        <label for="loginPassword" class="sr-only">密碼</label>
                        <input id="loginPassword" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="密碼">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        登入
                    </button>
                </div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="mt-8 space-y-6 hidden">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="registerUsername" class="sr-only">使用者名稱</label>
                        <input id="registerUsername" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="使用者名稱">
                    </div>
                    <div>
                        <label for="registerEmail" class="sr-only">電子郵件</label>
                        <input id="registerEmail" name="email" type="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="電子郵件">
                    </div>
                    <div>
                        <label for="registerPassword" class="sr-only">密碼</label>
                        <input id="registerPassword" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="密碼 (至少8位)">
                    </div>
                    <div>
                        <label for="registerConfirmPassword" class="sr-only">確認密碼</label>
                        <input id="registerConfirmPassword" name="confirmPassword" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="確認密碼">
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        註冊管理員
                    </button>
                </div>
            </form>

            <div class="text-center">
                <button id="toggleAuthMode" class="text-blue-600 hover:text-blue-500 text-sm">
                    切換到註冊模式
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Header -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold text-gray-900">SMTP 管理系統</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="adminInfo" class="text-sm text-gray-700"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm font-medium">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Navigation Tabs -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-8">
                    <button onclick="showTab('smtp', event)" class="tab-button active py-4 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">
                        SMTP 配置
                    </button>
                    <button onclick="showTab('api-keys', event)" class="tab-button py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        API 金鑰
                    </button>
                    <button onclick="showTab('email-logs', event)" class="tab-button py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                        郵件記錄
                    </button>
                </nav>
            </div>
        </div>

        <!-- Content -->
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- SMTP Config Tab -->
            <div id="smtp-tab" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-medium text-gray-900">SMTP 配置管理</h2>
                        <button onclick="openSmtpModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            新增 SMTP
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">主機</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">連接埠</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用者名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">月額度</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">已使用</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="smtpTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- API Keys Tab -->
            <div id="api-keys-tab" class="tab-content hidden">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-medium text-gray-900">API 金鑰管理</h2>
                        <button onclick="openApiKeyModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            新增 API 金鑰
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金鑰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">使用次數</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時限限制</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="apiKeysTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Email Logs Tab -->
            <div id="email-logs-tab" class="tab-content hidden">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-medium text-gray-900">郵件記錄</h2>
                        <button onclick="clearEmailLogs()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                            清空記錄
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時間</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">收件人</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">主旨</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">API 金鑰</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SMTP</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            顯示 <span id="logsStart">1</span> 到 <span id="logsEnd">10</span> 筆，共 <span id="logsTotal">0</span> 筆記錄
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="previousPage()" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">上一頁</button>
                            <span class="px-3 py-1 text-sm">第 <span id="currentPage">1</span> 頁</span>
                            <button onclick="nextPage()" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-50">下一頁</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SMTP Modal -->
    <div id="smtpModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="smtpModalTitle">新增 SMTP 配置</h3>
                <form id="smtpForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">名稱</label>
                            <input type="text" id="smtpName" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">主機</label>
                            <input type="text" id="smtpHost" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">連接埠</label>
                            <input type="number" id="smtpPort" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">使用者名稱</label>
                            <input type="text" id="smtpUsername" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">密碼</label>
                            <input type="password" id="smtpPassword" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">月額度</label>
                            <input type="number" id="smtpMaxQuota" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeSmtpModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">
                            儲存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="apiKeyModalTitle">新增 API 金鑰</h3>
                <form id="apiKeyForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">名稱</label>
                            <input type="text" id="apiKeyName" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">總使用次數限制</label>
                            <input type="number" id="apiKeyMaxUsage" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="留空表示無限制">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">每小時限制</label>
                            <input type="number" id="apiKeyMaxHourly" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="留空表示無限制">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">每日限制</label>
                            <input type="number" id="apiKeyMaxDaily" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="留空表示無限制">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">每月限制</label>
                            <input type="number" id="apiKeyMaxMonthly" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="留空表示無限制">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">過期時間</label>
                            <input type="datetime-local" id="apiKeyExpiresAt" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeApiKeyModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700">
                            儲存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script>
        let currentUser = null;
        let currentTab = 'smtp';
        let currentPage = 1;
        const pageSize = 20;

        // Check if admin registration is needed
        async function checkRegistrationStatus() {
            try {
                const response = await fetch('/api/admin/check-registration');
                const data = await response.json();
                
                if (data.needsRegistration) {
                    showRegisterForm();
                } else {
                    showLoginForm();
                }
            } catch (error) {
                console.error('Error checking registration status:', error);
                showLoginForm();
            }
        }

        function showLoginForm() {
            document.getElementById('authTitle').textContent = '管理員登入';
            document.getElementById('authSubtitle').textContent = '請輸入您的帳號密碼';
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('toggleAuthMode').textContent = '切換到註冊模式';
        }

        function showRegisterForm() {
            document.getElementById('authTitle').textContent = '註冊管理員';
            document.getElementById('authSubtitle').textContent = '首次使用請註冊管理員帳號';
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('toggleAuthMode').textContent = '切換到登入模式';
        }

        // Toggle between login and register
        document.getElementById('toggleAuthMode').addEventListener('click', function() {
            if (document.getElementById('loginForm').classList.contains('hidden')) {
                showLoginForm();
            } else {
                showRegisterForm();
            }
        });

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('adminToken', data.token);
                    currentUser = data.admin;
                    showAdminPanel();
                } else {
                    alert(data.error || '登入失敗');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('登入失敗');
            }
        });

        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            if (password !== confirmPassword) {
                alert('密碼確認不符');
                return;
            }

            if (password.length < 8) {
                alert('密碼至少需要8位字符');
                return;
            }

            try {
                const response = await fetch('/api/admin/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('adminToken', data.token);
                    currentUser = data.admin;
                    showAdminPanel();
                } else {
                    alert(data.error || '註冊失敗');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('註冊失敗');
            }
        });

        function showAdminPanel() {
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('adminInfo').textContent = `歡迎，${currentUser.username}`;
            loadData();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            currentUser = null;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('authForm').classList.remove('hidden');
            checkRegistrationStatus();
        }

        function showTab(tabName, event) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            if (event && event.target) {
                event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
                event.target.classList.remove('border-transparent', 'text-gray-500');
            }
            
            // Show tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            loadData();
        }

        async function loadData() {
            if (currentTab === 'smtp') {
                await loadSmtpConfigs();
            } else if (currentTab === 'api-keys') {
                await loadApiKeys();
            } else if (currentTab === 'email-logs') {
                await loadEmailLogs();
            }
        }

        // SMTP Functions
        async function loadSmtpConfigs() {
            try {
                const response = await fetch('/api/admin/smtp-configs', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const configs = await response.json();
                renderSmtpTable(configs);
            } catch (error) {
                console.error('Error loading SMTP configs:', error);
            }
        }

        function renderSmtpTable(configs) {
            const tbody = document.getElementById('smtpTableBody');
            tbody.innerHTML = '';

            configs.forEach(config => {
                const usagePercentage = (config.currentUsage / config.maxMonthlyQuota * 100).toFixed(1);
                const isOverQuota = config.currentUsage >= config.maxMonthlyQuota;
                
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${config.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.host}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.port}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${config.maxMonthlyQuota}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="${isOverQuota ? 'text-red-600' : 'text-green-600'}">${config.currentUsage} (${usagePercentage}%)</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${config.isActive && !isOverQuota ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${config.isActive && !isOverQuota ? '可用' : '不可用'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editSmtp(${config.id})" class="text-blue-600 hover:text-blue-900 mr-2">編輯</button>
                            <button onclick="deleteSmtp(${config.id})" class="text-red-600 hover:text-red-900">刪除</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // API Key Functions
        async function loadApiKeys() {
            try {
                const response = await fetch('/api/admin/api-keys', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const keys = await response.json();
                renderApiKeysTable(keys);
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        function renderApiKeysTable(keys) {
            const tbody = document.getElementById('apiKeysTableBody');
            tbody.innerHTML = '';

            keys.forEach(key => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${key.keyName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <code class="bg-gray-100 px-2 py-1 rounded text-xs">${key.keyValue.substring(0, 16)}...</code>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${key.usageCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${key.maxHourlyQuota ? `時:${key.maxHourlyQuota}` : ''} 
                            ${key.maxDailyQuota ? `日:${key.maxDailyQuota}` : ''} 
                            ${key.maxMonthlyQuota ? `月:${key.maxMonthlyQuota}` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${key.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${key.isActive ? '啟用' : '停用'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editApiKey(${key.id})" class="text-blue-600 hover:text-blue-900 mr-2">編輯</button>
                            <button onclick="deleteApiKey(${key.id})" class="text-red-600 hover:text-red-900">刪除</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Email Logs Functions
        async function loadEmailLogs() {
            try {
                const response = await fetch(`/api/admin/email-logs?page=${currentPage}&limit=${pageSize}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await response.json();
                renderEmailLogsTable(data.logs);
                updatePagination(data.pagination);
            } catch (error) {
                console.error('Error loading email logs:', error);
            }
        }

        function renderEmailLogsTable(logs) {
            const tbody = document.getElementById('emailLogsTableBody');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(log.sentAt).toLocaleString('zh-TW')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.to}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.subject}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${log.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${log.status === 'sent' ? '成功' : '失敗'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.apiKey?.keyName || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.smtpConfig?.name || '-'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updatePagination(pagination) {
            document.getElementById('currentPage').textContent = pagination.page;
            document.getElementById('logsStart').textContent = ((pagination.page - 1) * pagination.limit) + 1;
            document.getElementById('logsEnd').textContent = Math.min(pagination.page * pagination.limit, pagination.total);
            document.getElementById('logsTotal').textContent = pagination.total;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadEmailLogs();
            }
        }

        function nextPage() {
            currentPage++;
            loadEmailLogs();
        }

        // Modal Functions
        function openSmtpModal() {
            document.getElementById('smtpModalTitle').textContent = '新增 SMTP 配置';
            document.getElementById('smtpForm').reset();
            document.getElementById('smtpModal').classList.remove('hidden');
        }

        function closeSmtpModal() {
            document.getElementById('smtpModal').classList.add('hidden');
        }

        function openApiKeyModal() {
            document.getElementById('apiKeyModalTitle').textContent = '新增 API 金鑰';
            document.getElementById('apiKeyForm').reset();
            document.getElementById('apiKeyModal').classList.remove('hidden');
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        // Form submissions
        document.getElementById('smtpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('smtpName').value,
                host: document.getElementById('smtpHost').value,
                port: parseInt(document.getElementById('smtpPort').value),
                username: document.getElementById('smtpUsername').value,
                password: document.getElementById('smtpPassword').value,
                maxMonthlyQuota: parseInt(document.getElementById('smtpMaxQuota').value),
                isActive: true
            };

            try {
                const response = await fetch('/api/admin/smtp-configs', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeSmtpModal();
                    loadSmtpConfigs();
                } else {
                    const data = await response.json();
                    alert(data.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving SMTP config:', error);
                alert('儲存失敗');
            }
        });

        document.getElementById('apiKeyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                keyName: document.getElementById('apiKeyName').value,
                maxUsage: document.getElementById('apiKeyMaxUsage').value || null,
                maxHourlyQuota: document.getElementById('apiKeyMaxHourly').value || null,
                maxDailyQuota: document.getElementById('apiKeyMaxDaily').value || null,
                maxMonthlyQuota: document.getElementById('apiKeyMaxMonthly').value || null,
                expiresAt: document.getElementById('apiKeyExpiresAt').value || null
            };

            try {
                const response = await fetch('/api/admin/api-keys', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeApiKeyModal();
                    loadApiKeys();
                } else {
                    const data = await response.json();
                    alert(data.error || '儲存失敗');
                }
            } catch (error) {
                console.error('Error saving API key:', error);
                alert('儲存失敗');
            }
        });

        async function clearEmailLogs() {
            if (confirm('確定要清空所有郵件記錄嗎？此操作無法復原。')) {
                try {
                    const response = await fetch('/api/admin/email-logs/clear', {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                    });

                    if (response.ok) {
                        loadEmailLogs();
                    } else {
                        alert('清空記錄失敗');
                    }
                } catch (error) {
                    console.error('Error clearing email logs:', error);
                    alert('清空記錄失敗');
                }
            }
        }

        // SMTP CRUD functions
        function editSmtp(id) {
            // TODO: Implement edit functionality
            alert('編輯功能開發中...');
        }

        function deleteSmtp(id) {
            if (confirm('確定要刪除此 SMTP 配置嗎？')) {
                // TODO: Implement delete functionality
                alert('刪除功能開發中...');
            }
        }

        // API Key CRUD functions
        function editApiKey(id) {
            // TODO: Implement edit functionality
            alert('編輯功能開發中...');
        }

        function deleteApiKey(id) {
            if (confirm('確定要刪除此 API 金鑰嗎？')) {
                // TODO: Implement delete functionality
                alert('刪除功能開發中...');
            }
        }

        // Initialize
        checkRegistrationStatus();
    </script>
</body>
</html>